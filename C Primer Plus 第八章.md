# 2025/11/7 字符输入/输出与输入验证

## 单字符I/O：`getchar()`与`putchar()`

C的标准输入输出库`stdio`提供了两个高效处理字符输入输出的函数——`getchar()`与`putchar()`。

1. **`getchar()`** 的返回值为`int`类型，这是经过特殊设计的。`getchar()`需要返回两种可能的值：
   - 读取字符的ASCII码（0~255）
   - 文件结尾标识`EOF`（在`stdio.h`头文件中，`EOF`的值被定义为-1）

2. **`putchar()`** 接受`int`类型参数，这是为了与`getchar()`相呼应。`putchar()`在接收到`int`类型数据后，会将其转换为`unsigned char`类型，然后输出对应的字符。

虽然`getchar()`与`putchar()`一次只读取/输出一个字符，但这是很多字符处理程序的核心方法。

## 缓冲区

### 缓冲输入与非缓冲输入

- **缓冲输入**：在缓冲区填满或输入换行符时，才将缓冲区的数据提交给程序处理。
- **非缓冲输入**：在用户输入字符后立即处理并响应。

**缓冲区**是用于临时存储用户输入数据的内存区域。当缓冲区填满或读取到换行符时，系统会清空缓冲区并将数据提交给程序处理。

对C语言来说，将若干字符集合成块发送比逐一发送更高效。如果用户输入错误字符，也可以在缓冲区中直接修改而无需重启程序。

### 缓冲类型

缓冲输入分为两种形式：

1. **行缓冲**：在读取到换行符后提交并清空缓冲区
2. **完全缓冲**：在填满缓冲区后才提交并清空缓冲区

非缓冲模式多用于游戏等需要及时反馈的场景。C标准规定输入是缓冲的，这体现了C语言的可移植性——能否进行非缓冲输入实际上取决于操作系统。

## 结束键盘输入

### 文件、流和键盘输入

**文件**是存储器中存储信息的区域，通常由永久存储设备（如U盘、硬盘、DVD）存储。

C语言提供了多种处理文件的函数：

- **底层I/O函数**：直接与硬件交互，不经由任何缓冲和高级抽象
- **标准I/O包**：ASCLL C提供的标准I/O函数包，封装了各操作系统对数据的处理协议与操作

从概念上讲，C处理的是**流**而不是直接处理文件。

**流**是一种抽象概念，提供了一种连续、统一的视角来处理不同的输入/输出设备。流是对数据传输协议与操作的封装，有助于用户专注于数据的流向而不是具体的传输过程。

### 文件结尾

不同操作系统使用不同的特殊字符标记文件结尾。`getchar()`在读取到文件结尾时会返回特殊值`EOF`。在`stdio.h`文件中，`EOF`的值被声明为-1。

## 重定向和文件

C语言通过操作系统shell支持输入输出重定向。以下讨论命令行形式的重定向操作：

假设`const1`是可执行文件，`test1`、`test2`为文本文件。

### 1. 重定向输入

```bash
./const1 < test1
```

此命令使用标准输入重定向（`<`），将输入流从标准输入改为`test1`文件。操作为：**以`test1`文件的内容作为程序`const1`的输入，`const1`将运行结果发送至标准输出**。

### 2. 重定向输出

```bash
./const1 > test2
```

此命令使用标准输出重定向（`>`），将输出流从标准输出改为`test2`文件。操作为：**`const1`从标准输入端读取数据，将程序运行结果写入`test2`文件**。

注意：如果`test2`文件已存在，命令会先擦除原有内容再写入；如果不存在，则会先创建文件再写入结果。

### 3. 组合重定向

```bash
./const1 < test1 > test2
```

此命令组合了标准输入和输出重定向。操作为：**将`test1`的内容作为`const1`的输入，再将`const1`的运行结果写入`test2`中**。

> 注意：某些系统要求重定向运算符左侧有空格而右侧没有，其他系统可能允许运算符两侧有或没有空格。

C语言还提供了标准库`stdlib.h`，用于内存管理、文件操作等，相关内容将在第13章"文件输入/输出"中详细学习。

## 程序的输入验证

在设计程序时，应考虑用户可能的错误输入，并对输入进行验证——保留正确格式的输入，舍弃错误的输入。

输入验证通常涉及对`getchar()`、`scanf()`和循环结构的综合使用。例如，可以使用以下代码清空输入缓冲区中的无效输入：

```c
int ch;
while ((ch = getchar()) != '\n' && ch != EOF) {
    // 清空缓冲区
}
```

输入验证的具体实现需要根据实际应用场景进行设计，确保程序的健壮性和用户体验。